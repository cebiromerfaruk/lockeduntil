<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Zaman Kilitli Kasa â€” Geri Al</title>
<style>
  :root{ --bg1:#0f172a; --bg2:#f97316; --ink:#ffffff; --edge:rgba(255,255,255,.12); --btn:#10b981; --btn2:rgba(255,255,255,.06) }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, Segoe UI, Arial, sans-serif; color:var(--ink);
    background: radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,0.08), transparent 60%),
                linear-gradient(135deg,var(--bg1),var(--bg2));
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px;
  }
  .wrap{ width:100%; max-width:760px; }
  .card{
    background:rgba(255,255,255,.08); border:1px solid var(--edge); border-radius:16px;
    padding:20px 20px 12px; box-shadow:0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px);
  }
  h1{margin:0 0 6px 0; font-size:22px}
  p.desc{margin:0 0 14px 0; opacity:.9}
  label{display:block; font-weight:700; margin:12px 0 6px}
  input{
    width:100%; padding:12px; border-radius:12px; border:1px solid var(--edge);
    background:rgba(255,255,255,.06); color:#fff; font-size:15px;
  }
  .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
  .btn{
    appearance:none; border:none; cursor:pointer; padding:12px 16px; border-radius:12px; font-weight:800; letter-spacing:.2px;
    color:#071019; background:var(--btn); box-shadow:0 8px 24px rgba(16,185,129,.35);
  }
  .out{
    margin-top:14px; background:var(--btn2); border:1px solid var(--edge); padding:12px; border-radius:12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:14px;
  }
  .home{
    display:inline-block; margin-top:14px; padding:10px 14px; border-radius:12px;
    border:1px solid rgba(255,255,255,.25); text-decoration:none; color:#fff; background:transparent;
  }
  .home:hover{background:rgba(255,255,255,.06)}
  .err{color:#ffb4b4; font-weight:700}
  .badge{display:inline-block;font-size:12px;padding:4px 8px;border:1px solid var(--edge);border-radius:999px;opacity:.8;margin-bottom:10px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <span class="badge">retrieve v2</span>
      <h1>ðŸ”“ Zaman Kilitli Kasa â€” Geri Al</h1>
      <p class="desc" id="boot">Sayfa yÃ¼klendi (hazÄ±r).</p>

      <label>KayÄ±t IDâ€™si</label>
      <input id="idInput" placeholder="Ã¶r. k4k9ab12cd34" />

      <label>Parola</label>
      <input id="passInput" placeholder="Kaydederken verilen parola" />

      <div class="actions">
        <button id="getBtn" class="btn">Åžifreyi GÃ¶ster</button>
      </div>

      <div id="result" class="out" style="display:none"></div>

      <a class="home" href="./index.html">â¬… Ana sayfa</a>
    </div>
  </div>

<script>
  console.log('[retrieve] init');
  const API_BASE = ''; // aynÄ± origin

  function show(outEl, html){ outEl.style.display='block'; outEl.innerHTML = html; }

  document.getElementById('getBtn').addEventListener('click', async ()=>{
    const id = document.getElementById('idInput').value.trim();
    const passphrase = document.getElementById('passInput').value;
    const out = document.getElementById('result'); out.style.display='none'; out.innerHTML='';
    console.log('[retrieve] click', { idLen: id.length });

    if(!id) return alert('ID gerekli');
    if(!passphrase) return alert('Parola gerekli');

    try{
      const url = API_BASE + '/api/get/' + encodeURIComponent(id);
      console.log('[retrieve] fetch', url);
      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ passphrase })
      });
      const text = await res.text();
      console.log('[retrieve] status', res.status, 'body', text);
      let j = {};
      try { j = JSON.parse(text) } catch(_) { /* html vs dÃ¶nerse */ }

      if(!res.ok){
        const msg = j.error || ('HTTP '+res.status);
        if(res.status === 403){
          show(out, msg);
        } else {
          show(out, `<span class="err">Hata:</span> ${msg}`);
        }
        return;
      }

      if(j.owner){
        let html = '';
        if(j.secret){
          html += `<div><b>BaÅŸlÄ±k:</b> ${j.title || '-'}</div>`;
          html += `<div style="margin-top:8px"><b>Gizli metin:</b></div>`;
          html += `<pre style="white-space:pre-wrap;margin:6px 0 0 0">${j.secret}</pre>`;
        }else if(j.message){
          html += j.message;
        }
        html += `<div style="margin-top:10px"><label>E-posta</label><input id="updEmail" value="${j.email || ''}" /></div>`;
        html += `<div style="margin-top:10px"><label>EriÅŸim Tarihi</label><input id="updDate" type="date" value="${j.unlockDate || ''}" /></div>`;
        html += `<button id="updBtn" class="btn" style="margin-top:10px">GÃ¼ncelle</button>`;
        show(out, html);
        document.getElementById('updBtn').addEventListener('click', async ()=>{
          const email = document.getElementById('updEmail').value || '';
          const unlockDate = document.getElementById('updDate').value || '';
          try{
            const res2 = await fetch(API_BASE + '/api/update/' + encodeURIComponent(id), {
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ passphrase, email, unlockDate })
            });
            const j2 = await res2.json();
            if(!res2.ok) throw new Error(j2.error || 'GÃ¼ncelleme baÅŸarÄ±sÄ±z');
            show(out, 'GÃ¼ncellendi');
          }catch(e){
            show(out, `<span class="err">Hata:</span> ${e.message}`);
          }
        });
      } else {
        show(out, `<div><b>BaÅŸlÄ±k:</b> ${j.title || '-'}</div>
                 <div style="margin-top:8px"><b>Gizli metin:</b></div>
                 <pre style="white-space:pre-wrap;margin:6px 0 0 0">${j.secret}</pre>`);
      }
    }catch(e){
      console.error('[retrieve] error', e);
      const out = document.getElementById('result');
      show(out, `<span class="err">Hata:</span> ${e.message}`);
    }
  });
</script>
</body>
</html>
